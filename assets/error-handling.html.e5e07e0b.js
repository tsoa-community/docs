import{r as p,o as e,c as o,a as n,b as t,F as c,e as s,d as r}from"./app.c3fa13a7.js";import{_ as l}from"./plugin-vue_export-helper.21dcd24c.js";var u="/docs/assets/errors-server.06a3af98.png",i="/docs/assets/errors-client.e871ae56.png",k="/docs/assets/errors-json-client.a72b4976.png",d="/docs/assets/errors-json-server.58dc84b1.png",m="/docs/assets/err-422-swui.25b6edbd.png";const b={},h=n("h1",{id:"error-handling",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#error-handling","aria-hidden":"true"},"#"),s(" Error Handling")],-1),g={class:"custom-container warning"},f=n("p",{class:"custom-container-title"},"COMPATIBILITY NOTE",-1),y=s("This guide requires Node.js >= 8 and will target "),w={href:"https://expressjs.com",target:"_blank",rel:"noopener noreferrer"},v=s("express"),_=s(". We currently recommend using "),q={href:"https://yarnpkg.com/en/",target:"_blank",rel:"noopener noreferrer"},x=s("Yarn"),R=s(", npm should work but was not tested. This guide assumes you followed the "),E=n("a",{href:"'/getting-started'"},"getting started guide",-1),C=s(" or have a similar setup."),N=r('<p>As you may have noticed after following all the steps from the <a href="&#39;/getting-started&#39;">getting started guide</a>, our server does not allow for invalid parameters, but the response isn&#39;t very ideal yet.</p><p><img src="'+u+'" alt="Current Error Response"></p><p>For the Client, it looks something like this:</p><p><img src="'+i+`" alt="Client Error Response"></p><h2 id="setting-up-error-handling" tabindex="-1"><a class="header-anchor" href="#setting-up-error-handling" aria-hidden="true">#</a> Setting up error handling</h2><h3 id="handling-validation-errors" tabindex="-1"><a class="header-anchor" href="#handling-validation-errors" aria-hidden="true">#</a> Handling Validation Errors</h3><p>Let&#39;s first make sure that, whenever the Client triggers a Validation Error, instead of printing the stack trace, instead we show a properly formatted json response.</p><p>At the end of our <code>app.ts</code>, after the call to <code>RegisterRoutes(app)</code>, we&#39;ll add a global express error handler:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> express<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  Response <span class="token keyword">as</span> ExResponse<span class="token punctuation">,</span>
  Request <span class="token keyword">as</span> ExRequest<span class="token punctuation">,</span>
  NextFunction<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;express&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ValidateError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;tsoa&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span>
  err<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  req<span class="token operator">:</span> ExRequest<span class="token punctuation">,</span>
  res<span class="token operator">:</span> ExResponse<span class="token punctuation">,</span>
  next<span class="token operator">:</span> NextFunction
<span class="token punctuation">)</span><span class="token operator">:</span> ExResponse <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token keyword">instanceof</span> <span class="token class-name">ValidateError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Caught Validation Error for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>req<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>fields<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">422</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token string">&quot;Validation Failed&quot;</span><span class="token punctuation">,</span>
      details<span class="token operator">:</span> err<span class="token operator">?.</span>fields<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token string">&quot;Internal Server Error&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>Now, the same request will respond like this:</p><p><img src="`+k+'" alt="Client Error with handler"></p><p>Additionally, our console will show:</p><p><img src="'+d+`" alt="Server Error with handler"></p><h3 id="handling-missing-routes" tabindex="-1"><a class="header-anchor" href="#handling-missing-routes" aria-hidden="true">#</a> Handling missing routes</h3><p>In order to handle missing urls more gracefully, we can add a &quot;catch-all&quot; route handler:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// app.ts</span>
<span class="token keyword">import</span> express<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  Response <span class="token keyword">as</span> ExResponse<span class="token punctuation">,</span>
  Request <span class="token keyword">as</span> ExRequest<span class="token punctuation">,</span>
  NextFunction<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;express&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token function">RegisterRoutes</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">notFoundHandler</span><span class="token punctuation">(</span>_req<span class="token punctuation">,</span> res<span class="token operator">:</span> ExResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    message<span class="token operator">:</span> <span class="token string">&quot;Not Found&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="specifying-error-response-types-for-openapi" tabindex="-1"><a class="header-anchor" href="#specifying-error-response-types-for-openapi" aria-hidden="true">#</a> Specifying error response types for OpenAPI</h2><p>If you check out the Documentation endpoint, you&#39;ll notice that we don&#39;t have any documentation for our Errors yet. Since TypeScript does not check throwing Errors, tsoa can&#39;t infer the type of response we&#39;re sending out in these cases.</p><div class="custom-container warning"><p class="custom-container-title">WARNING</p><p>Please note that <code>@Response</code> has to be the tsoa import and can not currently be renamed (i.e. <code>import {Response as TsoaResponse} from &quot;tsoa&quot;</code>)</p></div><p>However, we have a way for you to manually specify these returns:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Body<span class="token punctuation">,</span> Controller<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> Route<span class="token punctuation">,</span> Response<span class="token punctuation">,</span> SuccessResponse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;tsoa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./user&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersService<span class="token punctuation">,</span> UserCreationParams <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./usersService&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">ValidateErrorJSON</span> <span class="token punctuation">{</span>
  message<span class="token operator">:</span> <span class="token string">&quot;Validation failed&quot;</span><span class="token punctuation">;</span>
  details<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">unknown</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Route</span></span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UsersController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token comment">// more code here</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Response</span></span><span class="token operator">&lt;</span>ValidateErrorJSON<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">422</span><span class="token punctuation">,</span> <span class="token string">&quot;Validation Failed&quot;</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">SuccessResponse</span></span><span class="token punctuation">(</span><span class="token string">&quot;201&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Created&quot;</span><span class="token punctuation">)</span> <span class="token comment">// Custom success response</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">createUser</span><span class="token punctuation">(</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> requestBody<span class="token operator">:</span> UserCreationParams
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// set return status 201</span>
    <span class="token keyword">new</span> <span class="token class-name">UsersService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>requestBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>This should make our docs show something like this:</p><p><img src="`+m+`" alt="SwaggerUI showing our 422 Response"></p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>OpenAPI allows matching status codes such as &#39;2xx&#39; or matching all codes using &#39;default&#39;. tsoa will support this:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token decorator"><span class="token at operator">@</span><span class="token function">Response</span></span><span class="token operator">&lt;</span>ErrorResponse<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">&#39;default&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Unexpected error&#39;</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">&#39;Response&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>TestModel<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></div><h2 id="typechecked-alternate-responses" tabindex="-1"><a class="header-anchor" href="#typechecked-alternate-responses" aria-hidden="true">#</a> Typechecked alternate responses</h2><div class="custom-container warning"><p class="custom-container-title">WARNING</p><p>This section applies to tsoa &gt;=3.1</p></div><p>In recent versions of tsoa, we have the option to inject a framework-agnostic responder function into our function that we can call to formulate a response that does not comply with the return type of our controller method/status code and headers (which is used for the success response). This is especially useful to reply with an error response without the risk of type mismatches associated with throwing errors. In order to inject one/more responders, we can use the <code>@Res()</code> decorator:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Route<span class="token punctuation">,</span> Controller<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> Query<span class="token punctuation">,</span> Res<span class="token punctuation">,</span> TsoaResponse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;tsoa&#39;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Route</span></span><span class="token punctuation">(</span><span class="token string">&#39;/greeting&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">GreetingsController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * <span class="token keyword">@param</span> <span class="token parameter">notFoundResponse</span> The responder function for a not found response
   */</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">greet</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> name<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Res</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> notFoundResponse<span class="token operator">:</span> TsoaResponse<span class="token operator">&lt;</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> reason<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">notFoundResponse</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> reason<span class="token operator">:</span> <span class="token string">&quot;We don&#39;t know you yet. Please provide a name&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Hello, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div>`,28);function S(T,I){const a=p("ExternalLinkIcon");return e(),o(c,null,[h,n("div",g,[f,n("p",null,[y,n("a",w,[v,t(a)]),_,n("a",q,[x,t(a)]),R,E,C])]),N],64)}var P=l(b,[["render",S]]);export{P as default};
